# 餐具检测系统 (Tableware Detection System)

## 项目概述

这是一个基于OpenCV的餐具质量检测系统，采用计算机视觉技术自动判断餐具的质量状态（OK/NG）。系统通过HSV颜色空间分析、形态学处理、连通域分析等图像处理技术，实现对餐具缺陷的自动检测。

## 核心功能

- **自动质量检测**: 对餐具图像进行自动分析，输出OK/NG结果
- **图像预处理**: 智能缩放图像，保留关键检测区域
- **HSV颜色分析**: 基于色相和饱和度进行缺陷区域分割
- **形态学处理**: 去噪声和填充处理，提高检测精度
- **连通域过滤**: 基于面积百分比过滤小干扰区域
- **模板匹配**: 多角度模板匹配，支持旋转角度测试
- **实时结果显示**: 多窗口显示处理过程和最终结果
- **交互式颜色分析**: 鼠标点击获取像素颜色信息
- **批量处理**: 支持单张和批量图像处理

## 技术架构

### 核心模块

#### 1. 主程序 (`main.cpp`)
- 命令行参数解析
- 图像读取和预处理
- 处理流水线控制
- 结果保存和显示
- 性能计时统计

#### 2. 图像处理模块 (`image_processing.cpp/h`)
核心算法函数：
- `createHueBinaryMask()`: HSV二值化分割
- `performMorphological()`: 形态学处理
- `fillContours()`: 轮廓填充
- `filterConnectedComponentsByPercent()`: 连通域过滤
- `judgeByTemplateMatch()`: 模板匹配质量判定

#### 3. 显示模块 (`display.cpp/h`)
用户界面功能：
- `createSubplotDisplay()`: 多图像子窗口布局
- `showColorAnalysis()`: 交互式颜色分析窗口
- `onMouse()`: 鼠标事件处理

#### 4. 配置模块 (`config_constants.h`)
可调参数配置：
- HSV颜色检测阈值
- 形态学处理参数
- 连通域过滤参数
- 模板匹配参数

## 检测算法流程

```
原始图像 → 缩放 → HSV转换 → 二值化分割 → 形态学处理 → 连通域过滤 → 模板匹配 → OK/NG判定
```

### 详细步骤

1. **图像缩放**: 将图像缩放到10%大小，提高处理速度
2. **HSV转换**: 将BGR图像转换为HSV颜色空间
3. **二值化分割**: 基于H通道(8-20)和S通道(≥150)进行颜色分割
4. **形态学处理**: 
   - 膨胀操作(4×4核): 连接断裂区域
5. **连通域过滤**: 过滤面积小于全图2%的小区域
6. **模板匹配**: 多角度旋转匹配，判断质量状态

## 编译和运行

### 系统要求

- **操作系统**: Windows 10/11
- **编译器**: Visual Studio 2019 或更新版本
- **CMake**: 版本 3.10 或更高
- **OpenCV**: 4.8.1 (项目内已包含)

### 编译步骤

1. **自动编译**（推荐）
   ```bat
   build.bat
   ```

2. **手动编译**
   ```bat
   mkdir build
   cd build
   cmake .. -G "Visual Studio 16 2019" -A x64
   cmake --build . --config Release
   ```

### 运行程序

#### 单张图像检测
```bat
build\Release\tableware_detection.exe image_path.jpg
```

#### 批量测试
```bat
test.bat
```

#### HSV颜色分析
```python
python color_analysis.py
```

测试脚本提供两种模式：
- **模式1**: 单张图片测试
- **模式2**: 文件夹批量处理

## 配置参数

主要参数在 `config_constants.h` 中配置：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MORPH_DILATE_KERNEL_SIZE` | 4 | 膨胀核大小 |
| `CONNECTED_COMPONENT_PERCENT` | 2.0 | 连通域面积阈值(%) |
| `RESIZE_SCALE` | 0.1 | 图像缩放比例(10%) |
| `BLUR_KERNEL_SIZE` | 3 | 高斯模糊核大小 |
| `HSV_RANGES` | 多组 | HSV检测范围配置 |
| `TEMPLATE_FOLDER` | "image_samples/2/muban" | 模板文件夹路径 |
| `ROTATION_MIN` | -6.0 | 最小旋转角度(°) |
| `ROTATION_MAX` | 6.0 | 最大旋转角度(°) |
| `ROTATION_STEP` | 3.0 | 角度步长(°) |
| `THRESHOLDS` | {0.85, 0.85} | 模板匹配阈值 |


## 输出结果

### 显示窗口
程序会显示包含6张子图的处理结果窗口：
1. 原始图像
2. 缩放后的图像
3. HSV二值化结果
4. 形态学处理结果
5. 轮廓填充结果
6. 连通域过滤结果

### 模板匹配
系统使用多角度模板匹配进行质量判定：
- **匹配方法**: TM_SQDIFF_NORMED (归一化平方差)
- **角度测试**: 中心扩散序列 [0°, +3°, -3°, +6°, -6°]
- **早停机制**: 找到满足阈值的匹配即停止测试
- **相似度计算**: 1.0 - minVal (越高越相似)

## 项目结构

```
tableware_detection/
├── include/                 # 头文件目录
│   ├── config_constants.h   # 配置参数定义
│   ├── display.h           # 显示函数声明
│   └── image_processing.h  # 图像处理函数声明
├── src/                    # 源文件目录
│   ├── main.cpp            # 主程序入口
│   ├── image_processing.cpp # 图像处理算法实现
│   └── display.cpp         # 显示功能实现
├── build/                  # 编译输出目录 (运行build.bat后生成)
│   └── Release/
│       ├── tableware_detection.exe
│       ├── opencv_world481.dll
│       └── opencv_videoio_ffmpeg481_64.dll
├── image_samples/          # 测试图片目录
│   ├── 1/                 # 测试图片集1
│   └── 2/                 # 测试图片集2
│       └── muban/         # 模板文件夹
├── opencv/                # OpenCV库文件
│   ├── build/
│   └── sources/
├── CMakeLists.txt         # CMake配置文件
├── build.bat              # 自动编译脚本
├── test.bat               # 测试运行脚本
├── color_analysis.py      # HSV颜色分析工具
├── 解释.md                # 技术说明文档
└── README.md              # 项目文档
```

## 交互功能

### 颜色分析模式
处理完成后，程序会进入交互式颜色分析模式：
- **鼠标点击**: 获取像素的HSV和BGR颜色值
- **ESC键**: 退出程序
- **实时显示**: 鼠标位置的颜色信息

## 性能指标

- **处理速度**: 单张图像通常在50-200ms内完成
- **内存占用**: 主要取决于输入图像大小
- **准确率**: 根据测试数据集和参数调优确定

## 辅助工具

### HSV颜色分析工具 (`color_analysis.py`)
Python脚本，用于分析餐具图片的HSV颜色分布，帮助确定合适的检测阈值：
- 计算HSV直方图和主要颜色峰值
- 分析不同颜色范围的像素占比
- 基于中心区域采样建议HSV阈值范围
- 可视化颜色分布和掩码结果

### 技术说明文档 (`解释.md`)
详细解释模板匹配中`minVal = 1`的原因和解决方案：
- 二值图像稀疏性对平方差匹配的影响
- 推荐使用像素重叠度(IOU)而非TM_SQDIFF_NORMED
- 不同匹配方法的对比分析

## 故障排除

### 常见问题

1. **编译失败**
   - 检查Visual Studio 2019是否正确安装
   - 确认CMake版本≥3.10

2. **运行时DLL缺失**
   - 编译会自动复制所需DLL文件到输出目录
   - 确保在build\Release目录下运行程序

3. **图像无法加载**
   - 检查图像文件路径是否正确
   - 支持格式：jpg, jpeg, png, bmp, tiff, tif

4. **检测结果不准确**
   - 调整`config_constants.h`中的HSV阈值参数
   - 根据具体应用场景优化判定阈值

## 更新日志

### v1.3.0 (2025-10-15)
- **清理**: 删除所有无用文件，包括之前尝试的各种方法（去雾处理、HSV LUT、HSV归一化、光照处理、ROI选择器等）
- **优化**: 简化项目结构，只保留核心功能文件
- **维护**: 更新CMakeLists.txt，移除已删除文件的引用

### v1.2.0 (2025-10-13)
- **重命名**: 项目更名为餐具检测系统(Tableware Detection)
- **优化**: 移除图像裁剪操作，直接处理完整图像
- **改进**: 更新所有相关文档和注释

### v1.1.0 (2025-09-28)
- **重构**: 重新组织项目结构，头文件与源文件分离
- **增强**: 新增灵活的位置偏移范围控制
- **改进**: 交互式颜色分析新增灰度值显示
- **优化**: 更清晰的模块化设计

### v1.0.0
- **基础**: 实现餐具缺陷检测核心功能
- **算法**: HSV颜色分析、形态学处理、连通域过滤
- **界面**: 多窗口显示和交互式颜色分析
- **工具**: 自动化编译和测试脚本

## 版本信息

- **当前版本**: 1.3.0
- **OpenCV版本**: 4.8.1
- **构建系统**: CMake 3.10+
- **编译器**: MSVC 2019+

## 许可证

本项目采用开源许可证，具体许可条款请参考LICENSE文件。

---

**注意**: 本系统专门针对特定的餐具检测场景设计，在实际应用中可能需要根据具体需求调整检测参数和算法。